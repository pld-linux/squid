Index: squid/src/ftp.c
diff -c squid/src/ftp.c:1.316.2.9 squid/src/ftp.c:1.316.2.10
*** squid/src/ftp.c:1.316.2.9	Sun May 11 11:30:13 2003
--- squid/src/ftp.c	Wed Jul 16 07:42:51 2003
***************
*** 266,271 ****
--- 266,277 ----
  ftpStateFree(int fdnotused, void *data)
  {
      FtpStateData *ftpState = data;
+     ftpState->ctrl.fd = -1;
+     if (ftpState->data.fd > -1) {
+ 	int fd = ftpState->data.fd;
+ 	ftpState->data.fd = -1;
+ 	comm_close(fd);
+     }
      cbdataFree(ftpState);
  }
  
***************
*** 312,321 ****
      stringClean(&ftpState->base_href);
      safe_free(ftpState->filepath);
      safe_free(ftpState->data.host);
-     if (ftpState->data.fd > -1) {
- 	comm_close(ftpState->data.fd);
- 	ftpState->data.fd = -1;
-     }
  }
  
  static void
--- 318,323 ----
***************
*** 1734,1740 ****
      ftpState->state = SENT_PASV;
      /*
       * ugly hack for ftp servers like ftp.netscape.com that sometimes
!      * dont acknowledge PORT commands.
       */
      commSetTimeout(ftpState->data.fd, 15, ftpTimeout, ftpState);
  }
--- 1736,1742 ----
      ftpState->state = SENT_PASV;
      /*
       * ugly hack for ftp servers like ftp.netscape.com that sometimes
!      * dont acknowledge PASV commands.
       */
      commSetTimeout(ftpState->data.fd, 15, ftpTimeout, ftpState);
  }
