Index: squid/src/cf.data.pre
diff -c squid/src/cf.data.pre:1.245.2.55 squid/src/cf.data.pre:1.245.2.56
*** squid/src/cf.data.pre:1.245.2.55	Sat Dec  6 10:19:36 2003
--- squid/src/cf.data.pre	Sun Dec 14 06:33:44 2003
***************
*** 3112,3117 ****
--- 3112,3128 ----
  	@DEFAULT_ICON_DIR@
  DOC_END
  
+ NAME: short_icon_urls
+ TYPE: onoff
+ LOC: Config.icons.use_short_names
+ DEFAULT: off
+ DOC_START
+ 	If this is enabled then Squid will use short URLs for icons.
+ 
+ 	If off then the URLs for icons will always be absolute URLs
+ 	including the proxy name and port.
+ DOC_END
+ 
  NAME: error_directory
  TYPE: string
  LOC: Config.errorDirectory
Index: squid/src/client_side.c
diff -c squid/src/client_side.c:1.561.2.47 squid/src/client_side.c:1.561.2.48
*** squid/src/client_side.c:1.561.2.47	Sun Dec 14 05:30:35 2003
--- squid/src/client_side.c	Sun Dec 14 06:33:46 2003
***************
*** 3044,3049 ****
--- 3044,3051 ----
  			http->flags.internal = 1;
  		    }
  		}
+ 		if (http->flags.internal)
+ 		    request->protocol = PROTO_HTTP;
  	    }
  	    /*
  	     * cache the Content-length value in request_t.
Index: squid/src/mime.c
diff -c squid/src/mime.c:1.102.2.2 squid/src/mime.c:1.102.2.3
*** squid/src/mime.c:1.102.2.2	Sat Nov  9 21:43:31 2002
--- squid/src/mime.c	Sun Dec 14 06:33:47 2003
***************
*** 219,228 ****
  const char *
  mimeGetIconURL(const char *fn)
  {
      char *icon = mimeGetIcon(fn);
      if (icon == NULL)
  	return null_string;
!     return internalLocalUri("/squid-internal-static/icons/", icon);
  }
  
  char *
--- 219,235 ----
  const char *
  mimeGetIconURL(const char *fn)
  {
+     static MemBuf mb = MemBufNULL;
      char *icon = mimeGetIcon(fn);
      if (icon == NULL)
  	return null_string;
!     if (Config.icons.use_short_names) {
! 	memBufReset(&mb);
! 	memBufPrintf(&mb, "/squid-internal-static/icons/%s", icon);
! 	return mb.buf;
!     } else {
! 	return internalLocalUri("/squid-internal-static/icons/", icon);
!     }
  }
  
  char *
Index: squid/src/structs.h
diff -c squid/src/structs.h:1.408.2.17 squid/src/structs.h:1.408.2.18
*** squid/src/structs.h:1.408.2.17	Sat Dec  6 10:19:38 2003
--- squid/src/structs.h	Sun Dec 14 06:33:47 2003
***************
*** 636,641 ****
--- 636,642 ----
      } cacheSwap;
      struct {
  	char *directory;
+ 	int use_short_names;
      } icons;
      char *errorDirectory;
      struct {
